'use strict'

exports.__esModule = true
exports.either = void 0
exports.oneOf = oneOf
exports.taggedUnion = taggedUnion

var _Decoder = require('../Decoder')

var _utils = require('../_utils')

var _objects = require('./objects')

var _utilities = require('./utilities')

var EITHER_PREFIX = 'Either:\n'

function itemize(s) {
  return '-' + (0, _utils.indent)(s).substring(1)
}

function nest(errText) {
  return errText.startsWith(EITHER_PREFIX) ? errText.substr(EITHER_PREFIX.length) : itemize(errText)
}

function _either() {
  for (var _len = arguments.length, decoders = new Array(_len), _key = 0; _key < _len; _key++) {
    decoders[_key] = arguments[_key]
  }

  if (decoders.length === 0) {
    throw new Error('Pass at least one decoder to either()')
  }

  return (0, _Decoder.define)(function (blob, _, err) {
    var errors = []

    for (var _i = 0; _i < decoders.length; _i++) {
      var result = decoders[_i].decode(blob)

      if (result.ok) {
        return result
      } else {
        errors.push(result.error)
      }
    }

    var text =
      EITHER_PREFIX +
      errors
        .map(function (err) {
          return nest((0, _utils.summarize)(err).join('\n'))
        })
        .join('\n')
    return err(text)
  })
}

var either = _either

exports.either = either

function oneOf(constants) {
  return (0, _Decoder.define)(function (blob, ok, err) {
    var winner = constants.find(function (c) {
      return c === blob
    })

    if (winner !== undefined) {
      return ok(winner)
    }

    return err(
      'Must be one of ' +
        constants
          .map(function (value) {
            return JSON.stringify(value)
          })
          .join(', ')
    )
  })
}

function taggedUnion(field, mapping) {
  var _object

  var base = (0, _objects.object)(((_object = {}), (_object[field] = (0, _utilities.prep)(String, oneOf(Object.keys(mapping)))), _object)).transform(function (o) {
    return o[field]
  })
  return base.peek_UNSTABLE(function (_ref) {
    var blob = _ref[0],
      key = _ref[1]
    var decoder = mapping[key]
    return decoder.decode(blob)
  })
}
